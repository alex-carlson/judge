<!doctype html>
<html>
  <head>
    <title>Surface</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0" />
    <link href='https://fonts.googleapis.com/css?family=Lato:100,400,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <!-- Load the Paper.js library -->
    <script type="text/javascript" src="paper-full.min.js"></script>
    <!-- Define inlined PaperScript associate it with myCanvas -->
  </head>
  <body>
    <section class="welcome">
      <h1>welcome!</h1>
      <button id="join">Join Game</button>
    </section>
    <section id="scoreboard">
      <ul id="playerList"></ul>
    </section>

    <section class="draw">
      <h1>drawings recieved: <span class="recieved">0</span>/<span class="playercount">0</span></h1>
      <div class="rangeholder">
        <input type="range" id="brushSize" value="5" min="1" max="35">
        <span id="smallStroke">1</span>
        <span id="bigStroke">45</span>
      </div>
      <div class="colors">
        <span class="red" data-color="red">red</span>
        <span class="green" data-color="green">green</span>
        <span class="blue" data-color="blue">blue</span>
        <span class="yellow" data-color="yellow">yellow</span>
        <span class="black" data-color="black">black</span>
        <span class="white" data-color="white">white</span>
      </div>
      <canvas id="myCanvas" resize></canvas>
      <button id="submit">submit your drawing</button>
    </section>

    <section class="gameinprogress">
      <h1>Game is in progress.  :(</h1>
      <h4>Please wait for the current game to end.</h4>
    </section>

    <section class="wait">
      <h1>waiting for everyone to submit a drawing...</h1>
      <p>drawings recieved: <span class="recieved">0</span>/<span class="playercount">0</span></p>
    </section>

    <section class="vote">
      <span class="votingSection">
        <h1 id="drawingPrompt">drawing prompt</h1>
        <div class="col half" id="left">
          <h2 class="leftplayer"></h2>
          <canvas data-player="null" id="leftCanvas"></canvas>
        </div>
        <div class="col half" id="right">
          <h2 class="rightplayer"></h2>
          <canvas data-player="null" id="rightCanvas"></canvas>
        </div>
      </span>
    </section>

    <section class="gameOver">
      <h1>Game Over!</h1>
      <h4></h4>
      <button class="restart">Restart</button>
    </section>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script type="text/paperscript" src="drawing.js" canvas="myCanvas"></script>
    <script>
      var socket = io();
      var players, drawings, uniqueID;
      var votedFor;

      // load game

      $('section, section .votingSection').fadeOut();
      $('.welcome').fadeIn(1000);

      // join the game

      $('#join').click(function(){
        $('section').fadeOut(500);
        $('.draw').fadeIn(500);
      })

      socket.on('playerID', function(data){
        uniqueID = data;
      })

      // the submit drawing logic is in drawing.js.  It's gross but I haven't figured out a good workaround yet...

      // when we get a new drawing from a player

      socket.on('drawingCount', function(data){
        $('.recieved').html(data.length);
        drawings = data.length;

        // on submit drawing
        socket.emit('sendImage', data);
        startPlaying();
      })

      // when a new player connects

      socket.on('players', function(data, ips){
        $('.playercount').html(data);
        players = data;
        startPlaying();

        $('#playerList').html('');
        if(ips != []){
          // get number of players and add them to the clientside list
          for(i = 0; i < ips.length; i++){
            $('#playerList').append('<li id="'+ips[i][0]+'">player '+(i+1)+' : <b>'+ips[i][1]+'</b></li>');
          }
        }
      })

      // someone submitted a vote, update the score!

      socket.on('updateScore', function(data){
        $('#playerList').html('');
        if(data != []){

          // get all the players and list 'em out in a ul
          for(i = 0; i < data.length; i++){
            $('#playerList').append('<li id="'+data[i][0]+'">player '+(i+1)+' : <b>'+data[i][1]+'</b></li>');
          }
        }
      })

      // game over, someone got all the points!

      socket.on('gameOver', function(data){
        $('section').fadeOut(500);
        $('.gameOver').fadeIn(500);

        // check if the winner id belongs to this player

        if(data[0] == uniqueID){
          $('.gameOver h4').html('YOU WIN!');
        } else {
          $('.gameOver h4').html('YOU LOSE!');
        }
      })

      function startPlaying(){

        // if not enough players

        if(drawings == players && players < 2){
          $('.wait h1').html('waiting for more players...');
        }

        //we're ready to start juding!

        if(drawings == players && players >= 2){
          $('.wait').fadeOut(500);
          $('.vote, .votingSection').fadeOut(500);
          $('.vote, .votingSection, #scoreboard').fadeIn(500);
          socket.emit('getImage');
        }

      }

      // restart button logic

      $('.restart').click(function(){
        $('section').fadeOut(500);
        $('.welcome').fadeIn(500);
        socket.emit('restart');
      })

      // this happens when you vote on a drawing

      $('#rightCanvas, #leftCanvas').click(function(){
        votedFor = $(this).attr('data-player');
        socket.emit('vote', votedFor);
        $('#rightCanvas, #leftCanvas').addClass('disabled');
      })

      // once we get all the votes

      socket.on('votesCast', function(){
        startPlaying();
      })
    </script>
  </body>
</html>